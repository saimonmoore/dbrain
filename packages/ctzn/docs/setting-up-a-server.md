# How to set up a CTZN server

This guide will assume you're starting from scratch, using Google Cloud, and using a Debian-variant distro.

## Step 1 - Create VM

Create a new VM instance. Recommended settings:

- OS: Debian or Ubuntu
- RAM: At least 4GB
- Disk: At least 10GB

Required settings:

- Firewall: Allow HTTP and HTTPS traffic

## Step 2 - Setup VM

Once the VM is active:

- [Install NVM](https://nvm.sh) and then install Node 14 or higher.
- Install nginx `sudo apt-get install nginx`
- Install CTZN `npm install -g ctzn`
- Install PM2 `npm install -g pm2`

## Step 4 - Setup your DNS record

Point your domain name's A record to the server. We'll refer to that domain as `$DOMAIN` from here on out.

## Step 5 - Enable gcloud's PTR record

**Note: CTZN requires a PTR record so if you're using a different platform than Google Cloud, you WILL need to solve this.**

From the Compute Engine dashboard, follow these steps:

- Click on the VM.
- Click "Edit" in the header.
- Scroll down to the "Network interfaces" section. You should have one entry which says "nic0: default" or similar.
- Click the edit-pen on the network interface.
- Toggle the "Public DNS PTR Record" setting to "Enabled."
- Enter your domain name (`$DOMAIN`) as the value.
- Click "Done".
- Click "Save" at the bottom of the page.

GCloud may give you an error saying you need to verify ownership of the domain before enabling the PTR record. Follow the steps they provide (it's fairly intuitive) and then complete these steps again.

## Step 6 - Start CTZN

Create `~/ctzn.sh` and paste the following line into it:

```
ctzn start --domain $DOMAIN
```

(Remember to replace `$DOMAIN` with your actual domain name.)

Save `~/ctzn.sh` and then run the following command:

```
pm2 start ~/ctzn.sh
```

You can ensure that CTZN started correctly by running `pm2 log` and checking for error messages.

## Step 7 - Setup your certificate with LetsEncrypt

Follow these steps (again, we're assuming you're using Debian):

- Install snapd `sudo apt-get install snapd`
- Update snapd `sudo snap install core; sudo snap refresh core`
- Install certbot `sudo snap install --classic certbot`
- Setup your certbot exec path `sudo ln -s /snap/bin/certbot /usr/bin/certbot`
- Use certbot's setup process `sudo certbot --nginx`

## Step 8 - Configure the nginx reverse proxy

Start by opening the site config in your preferred editor:

```
sudo vim /etc/nginx/sites-enabled/default
```

Find the server config generated by certbot (it will say "# managed by Certbot") and locate this section:

```
location / {
  try_files $uri $uri/ =404;
}
```

Replace this with:

```
location / {
  proxy_pass http://127.0.0.1:3000;

  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
}
```

Save and quit the editor, then run:

```
sudo service nginx reload
```

## Step 9 - Open your firewall rules (optional)

It's not clear whether this is needed, but you might want to create firewall rules which allow ingress and egress from UDP and TCP in the port ranges of 1024-65335.

## Done!

You should now see a CTZN welcome screen at your domain.
Your server is ready for people to use!